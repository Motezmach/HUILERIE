generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String    @id @default(uuid())
  username    String    @unique
  password    String
  email       String?   @unique
  firstName   String?
  lastName    String?
  role        UserRole  @default(ADMIN)
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("users")
}

model Farmer {
  id                 String              @id @default(uuid())
  name               String
  nickname           String?
  phone              String?
  type               FarmerType          @default(SMALL)
  pricePerKg         Decimal?
  dateAdded          DateTime            @default(now())
  totalAmountDue     Decimal             @default(0)
  totalAmountPaid    Decimal             @default(0)
  paymentStatus      PaymentStatus       @default(PENDING)
  lastProcessingDate DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  farmerNote         String?
  currentBoxes       Box[]               @relation("CurrentFarmerBoxes")
  processingSessions ProcessingSession[]

  @@map("farmers")
}

model Box {
  id              String       @id
  type            BoxType      @default(NORMAL)
  status          BoxStatus    @default(AVAILABLE)
  currentFarmerId String?
  currentWeight   Decimal?
  assignedAt      DateTime?
  isSelected      Boolean      @default(false)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  currentFarmer   Farmer?      @relation("CurrentFarmerBoxes", fields: [currentFarmerId], references: [id])
  sessionBoxes    SessionBox[]

  @@map("boxes")
}

model ProcessingSession {
  id                  String               @id @default(uuid())
  farmerId            String
  sessionNumber       String               @unique
  processingDate      DateTime?
  oilWeight           Decimal              @default(0)
  totalBoxWeight      Decimal
  boxCount            Int
  totalPrice          Decimal?
  pricePerKg          Decimal?
  amountPaid          Decimal              @default(0)
  remainingAmount     Decimal              @default(0)
  processingStatus    ProcessingStatus     @default(PENDING)
  paymentStatus       PaymentStatus        @default(UNPAID)
  paymentDate         DateTime?
  notes               String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  oilUnit             String               @default("kg")
  paymentTransactions PaymentTransaction[]
  farmer              Farmer               @relation(fields: [farmerId], references: [id], onDelete: Cascade)
  sessionBoxes        SessionBox[]

  @@map("processing_sessions")
}

model SessionBox {
  id        String            @id @default(uuid())
  sessionId String
  boxId     String
  boxWeight Decimal
  boxType   BoxType
  farmerId  String
  createdAt DateTime          @default(now())
  box       Box               @relation(fields: [boxId], references: [id], onDelete: Cascade)
  session   ProcessingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, boxId])
  @@map("session_boxes")
}

model PaymentTransaction {
  id            String            @id @default(uuid())
  sessionId     String
  amount        Decimal
  paymentDate   DateTime          @default(now())
  paymentMethod String?
  notes         String?
  createdAt     DateTime          @default(now())
  session       ProcessingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("payment_transactions")
}

model DashboardMetrics {
  id                   String   @id @default(uuid())
  metricDate           DateTime @unique
  totalFarmers         Int      @default(0)
  totalBoxes           Int      @default(0)
  activeBoxes          Int      @default(0)
  pendingExtractions   Int      @default(0)
  todayRevenue         Decimal  @default(0)
  totalRevenue         Decimal  @default(0)
  averageOilExtraction Decimal  @default(0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@map("dashboard_metrics")
}

model OilSafe {
  id           String          @id @default(uuid())
  name         String          @unique
  capacity     Decimal
  currentStock Decimal         @default(0)
  description  String?
  isActive     Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  sales        OilSale[]
  purchases    OlivePurchase[]

  @@map("oil_safes")
}

model OlivePurchase {
  id              String   @id @default(uuid())
  purchaseDate    DateTime @default(now())
  farmerName      String
  farmerPhone     String?
  oliveWeight     Decimal
  pricePerKg      Decimal
  totalCost       Decimal
  oilProduced     Decimal?
  yieldPercentage Decimal?
  safeId          String
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  safe            OilSafe  @relation(fields: [safeId], references: [id], onDelete: Cascade)

  @@map("olive_purchases")
}

model OilSale {
  id           String   @id @default(uuid())
  saleDate     DateTime @default(now())
  safeId       String
  quantity     Decimal
  pricePerKg   Decimal
  totalRevenue Decimal
  buyer        String?
  buyerPhone   String?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  safe         OilSafe  @relation(fields: [safeId], references: [id], onDelete: Cascade)

  @@map("oil_sales")
}

model Transaction {
  id              String          @id @default(uuid())
  type            TransactionType
  amount          Decimal
  description     String
  farmerName      String?
  farmerId        String?
  sessionId       String?
  destination     String?
  createdBy       String?
  transactionDate DateTime        @default(now())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@map("transactions")
}

model Employee {
  id         String            @id @default(uuid())
  name       String
  phone      String?
  position   String?
  hireDate   DateTime          @default(now())
  isActive   Boolean           @default(true)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  attendance Attendance[]
  payments   EmployeePayment[]

  @@map("employees")
}

model EmployeePayment {
  id          String   @id @default(uuid())
  employeeId  String
  amount      Decimal
  paymentDate DateTime @default(now())
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId, paymentDate])
  @@map("employee_payments")
}

model Attendance {
  id         String           @id @default(uuid())
  employeeId String
  date       DateTime
  status     AttendanceStatus
  notes      String?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  employee   Employee         @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, date], name: "employeeId_date")
  @@map("attendance")
}

model CollectorGroup {
  id          String             @id @default(uuid())
  name        String             @unique
  isActive    Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  payments    CollectorPayment[]
  collections DailyCollection[]

  @@map("collector_groups")
}

model DailyCollection {
  id                String         @id @default(uuid())
  groupId           String
  collectionDate    DateTime
  location          String
  clientName        String
  chakraCount       Int            @default(0)
  galbaCount        Int            @default(0)
  nchiraChakraCount Int            @default(0)
  nchiraGalbaCount  Int            @default(0)
  totalChakra       Decimal
  pricePerChakra    Decimal        @default(0)
  totalAmount       Decimal        @default(0)
  notes             String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  group             CollectorGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([collectionDate, groupId])
  @@map("daily_collections")
}

model CollectorPayment {
  id          String         @id @default(uuid())
  groupId     String
  amount      Decimal
  paymentDate DateTime       @default(now())
  notes       String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  group       CollectorGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId, paymentDate])
  @@map("collector_payments")
}

enum FarmerType {
  SMALL
  LARGE
}

enum BoxType {
  NCHIRA
  CHKARA
  NORMAL
}

enum BoxStatus {
  AVAILABLE
  IN_USE
}

enum ProcessingStatus {
  PENDING
  PROCESSED
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
  PENDING
}

enum UserRole {
  ADMIN
  USER
  MANAGER
}

enum TransactionType {
  FARMER_PAYMENT
  DEBIT
  CREDIT
}

enum AttendanceStatus {
  PRESENT
  HALF_DAY
  ABSENT
}
